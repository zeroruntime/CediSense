{% extends layout_path %}

{% load humanize %}
{% load static %}
{% load i18n %}

{% block title %}Transactions{% endblock %}

{% block page_css %}
{{ block.super }}
<script src="{% static 'js/ui-modals.js' %}"></script>
<link rel="stylesheet" href="{% static 'vendor/css/pages/page-icons.css' %}" />
{% endblock page_css %}

{%block content %}

<div class="container my-4">
  <div class="modal fade" id="editTransactionModal" tabindex="-1" aria-labelledby="editTransactionModalLabel"
    aria-hidden="true">
  </div>
  <div class="modal fade" id="deleteTransactionModal" tabindex="-1" aria-labelledby="deleteTransactionModalLabel"
    aria-hidden="true">
  </div>

  <div class="container my-5">
    {% if messages %}
    <div class="messages mb-3">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

  <!-- Page Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="fw-bold mt-3">Transactions</h3>
    <style>
      @media only screen and (max-width: 479.98px) {
        .add-t-button{
          font-size: 0.8rem !important;
        }
      }
    </style>
    <a href="" class="btn btn-primary add-t-button" data-bs-toggle="modal" data-bs-target="#transactionModal">Add
      Transaction</a>
  </div>

  {% include 'add_transactions.html' %}

  <!-- Filter Section -->
  <div class="card mb-4">
    <div class="card-body">
      <form method="GET" class="row g-3">
        <div class="col-md-3">
          <label for="type" class="form-label">Type</label>
          <select id="type" name="type" class="form-select">
            <option value="">All</option>
            <option value="income">Income</option>
            <option value="expense">Expense</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="category" class="form-label">Category</label>
          <select id="category" name="category" class="form-select">
            <option value="">All Categories</option>
            <!-- Populate categories dynamically -->
            {% for category in categories %}
            <option value="{{ category.id }}">{{ category.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label for="start_date" class="form-label">Start Date</label>
          <input type="date" id="start_date" name="start_date" class="form-control">
        </div>
        <div class="col-md-3">
          <label for="end_date" class="form-label">End Date</label>
          <input type="date" id="end_date" name="end_date" class="form-control">
        </div>
        <div class="col-12">
          <button type="submit" class="btn btn-primary mt-3">Filter</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Transactions List -->
  <div class="table-responsive">
    <table class="table table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th>Date</th>
          <th>Description</th>
          <th>Category</th>
          <th class="text-end">Amount</th>
          <th class="text-center">Type</th>
          <th class="text-center">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for transaction in transactions %}
        <tr>
          <td class="text-wrap">{{ transaction.date }}</td>
          <td>{{ transaction.description }}</td>
          <td>{{ transaction.category.name }}</td>
          <td class="text-end">
            {% if transaction.amount < 0 %} <span class="text-danger">- ${{ transaction.amount }}</span>
              {% else %}
              <span class="text-success">${{ transaction.amount|floatformat:2|intcomma }}</span>
              {% endif %}
          </td>
          <td class="text-center">
            {% if transaction.category.type == 'Income' %}
            <span class="badge bg-success">Income</span>
            {% else %}
            <span class="badge bg-danger">Expense</span>
            {% endif %}
          </td>
          <td class="text-center text-nowrap">
            <button type="button" class="btn btn-warning btn-sm" data-bs-toggle="modal"
              onclick="loadEditModal('{{ transaction.id }}')" data-bs-target="#editTransactionModal">
              Edit
            </button>
            <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal"
              onclick="loadDeleteModal('{{ transaction.id }}')" data-bs-target="#deleteTransactionModal">
              Delete
            </button>

          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" class="text-center text-muted">No transactions found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>


  <!-- Totals Summary -->
  <div class="d-flex justify-content-end mt-4">
    <div class="me-5 text-end">
      <h5 class="text-secondary">Total Income</h5>
      <p class="fw-bold text-success">${{ total_income }}</p>
    </div>
    <div class="me-5 text-end">
      <h5 class="text-secondary">Total Expenses</h5>
      <p class="fw-bold text-danger">${{ total_expenses }}</p>
    </div>
    <div class="text-end">
      <h5 class="text-secondary">Balance</h5>
      <p class="fw-bold">${{ balance }}</p>
    </div>
  </div>
</div>

<script>
  function loadEditModal(transactionId) {
    const modal = document.getElementById('editTransactionModal');

    // Clean up any existing backdrop
    const existingBackdrop = document.querySelector('.modal-backdrop');
    if (existingBackdrop) {
      existingBackdrop.remove();
    }

    fetch(`{% url 'edit-transactions' %}?transaction_id=${transactionId}`)
      .then(response => response.text())
      .then(html => {
        modal.innerHTML = html;
        const bootstrapModal = new bootstrap.Modal(modal);

        // Handle modal hidden event
        modal.addEventListener('hidden.bs.modal', function () {
          document.body.classList.remove('modal-open');
          const backdrop = document.querySelector('.modal-backdrop');
          if (backdrop) {
            backdrop.remove();
          }
        });

        bootstrapModal.show();
      });
  }
  function loadDeleteModal(transactionId) {
    const modal = document.getElementById('deleteTransactionModal');
    
    // Clean up any existing backdrop
    const existingBackdrop = document.querySelector('.modal-backdrop');
    if (existingBackdrop) {
        existingBackdrop.remove();
    }
    
    fetch(`{% url 'delete-transactions' %}?transaction_id=${transactionId}`)
        .then(response => response.text())
        .then(html => {
            modal.innerHTML = html;
            const bootstrapModal = new bootstrap.Modal(modal);
            
            // Handle modal hidden event
            modal.addEventListener('hidden.bs.modal', function () {
                document.body.classList.remove('modal-open');
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) {
                    backdrop.remove();
                }
            });
            
            bootstrapModal.show();
        });
}
</script>

{% endblock %}